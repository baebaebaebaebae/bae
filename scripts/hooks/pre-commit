#!/bin/bash

set -e

# Dependency graph (update when crate dependencies change):
#   bae-core: no local deps
#   bae-ui: no local deps
#   bae-desktop: depends on bae-core, bae-ui
#   bae-mocks: depends on bae-ui

TMPFILE=$(mktemp)
trap "rm -f $TMPFILE" EXIT

# Get changed files (staged for commit)
CHANGED_FILES=$(git --no-pager diff --cached --name-only)

has_changes_in() {
    if echo "$CHANGED_FILES" | grep -q "^$1/"; then
        echo "Changes detected in $1"
        return 0
    fi
    return 1
}

run_check() {
    local name="$1"
    shift
    echo "Running $name..."
    if "$@" > "$TMPFILE" 2>&1; then
        return 0
    else
        echo ""
        echo "❌ $name failed:"
        cat "$TMPFILE"
        return 1
    fi
}

# bae-core checks
if has_changes_in "bae-core"; then
    cd bae-core

    run_check "cargo fmt (bae-core)" cargo fmt -- --check || {
        echo "Run 'cargo fmt' in the bae-core directory to fix formatting"
        exit 1
    }

    run_check "clippy lib (bae-core)" cargo clippy --lib -- -D warnings -A unexpected_cfgs -A deprecated || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    run_check "clippy tests (bae-core)" cargo clippy --tests --features test-utils -- -D warnings -A unexpected_cfgs -A deprecated || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    for test in tests/*.rs; do
        testname=$(basename "$test" .rs)
        run_check "clippy integration test: $testname" cargo clippy --test "$testname" --features test-utils -- -D warnings -A unexpected_cfgs -A deprecated || {
            exit 1
        }
    done

    run_check "tests (bae-core)" cargo test --features test-utils || {
        echo "Fix the failing tests and try again"
        exit 1
    }

    cd ..
fi

# bae-ui checks
if has_changes_in "bae-ui"; then
    cd bae-ui

    run_check "cargo fmt (bae-ui)" cargo fmt -- --check || {
        echo "Run 'cargo fmt' in the bae-ui directory to fix formatting"
        exit 1
    }

    run_check "clippy (bae-ui)" cargo clippy -- -D warnings || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    run_check "clippy wasm32 (bae-ui)" cargo clippy --target wasm32-unknown-unknown -- -D warnings || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    cd ..
fi

# bae-desktop checks (depends on bae-core, bae-ui)
if has_changes_in "bae-desktop" || has_changes_in "bae-core" || has_changes_in "bae-ui"; then
    cd bae-desktop

    run_check "cargo fmt (bae-desktop)" cargo fmt -- --check || {
        echo "Run 'cargo fmt' in the bae-desktop directory to fix formatting"
        exit 1
    }

    run_check "dx fmt (bae-desktop)" dx fmt --check || {
        echo "Run 'dx fmt' in the bae-desktop directory to fix formatting"
        exit 1
    }

    run_check "clippy (bae-desktop)" env BINDGEN_EXTRA_CLANG_ARGS="-I/opt/homebrew/include" cargo clippy -- -D warnings -A unexpected_cfgs -A deprecated || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    cd ..
fi

# bae-mocks checks (depends on bae-ui)
if has_changes_in "bae-mocks" || has_changes_in "bae-ui"; then
    cd bae-mocks

    run_check "cargo fmt (bae-mocks)" cargo fmt -- --check || {
        echo "Run 'cargo fmt' in the bae-mocks directory to fix formatting"
        exit 1
    }

    run_check "dx fmt (bae-mocks)" dx fmt --check || {
        echo "Run 'dx fmt' in the bae-mocks directory to fix formatting"
        exit 1
    }

    run_check "clippy (bae-mocks)" cargo clippy -- -D warnings || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    run_check "clippy wasm32 (bae-mocks)" cargo clippy --target wasm32-unknown-unknown -- -D warnings || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    # Run playwright e2e tests
    cd e2e
    run_check "playwright tests (bae-mocks)" npm test || {
        echo "Fix the failing e2e tests and try again"
        exit 1
    }
    cd ../..
fi

echo "✅ All checks passed"
exit 0
