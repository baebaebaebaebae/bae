#!/bin/sh

# Run cargo fmt check in the bae directory
cd bae

echo "Running cargo fmt check..."
cargo fmt -- --check

if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Commit rejected: Code is not formatted correctly"
    echo "Run 'cargo fmt' in the bae directory to fix formatting"
    exit 1
fi

echo "Running dx fmt check..."
dx fmt --check

if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Commit rejected: RSX code is not formatted correctly"
    echo "Run 'dx fmt' in the bae directory to fix formatting"
    exit 1
fi

echo "Running cargo clippy on library..."
cargo clippy --lib -- -D warnings -A unexpected_cfgs -A deprecated

if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Commit rejected: Clippy found warnings in library code"
    echo "Fix the warnings above and try again"
    exit 1
fi

echo "Running cargo clippy on unit tests..."
cargo clippy --tests --features test-utils -- -D warnings -A unexpected_cfgs -A deprecated

if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Commit rejected: Clippy found warnings in unit test code"
    echo "Fix the warnings above and try again"
    exit 1
fi

echo "Running cargo clippy on integration tests..."
for test in tests/*.rs; do
    testname=$(basename "$test" .rs)
    cargo clippy --test "$testname" --features test-utils -- -D warnings -A unexpected_cfgs -A deprecated
    if [ $? -ne 0 ]; then
        echo ""
        echo "❌ Commit rejected: Clippy found warnings in integration test: $testname"
        echo "Fix the warnings above and try again"
        exit 1
    fi
done

echo "Running tests..."
cargo test --features test-utils

if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Commit rejected: Tests failed"
    echo "Fix the failing tests and try again"
    exit 1
fi

echo "✅ All checks passed"
exit 0

