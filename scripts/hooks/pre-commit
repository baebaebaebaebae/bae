#!/bin/bash

set -e

# Dependency graph (update when crate dependencies change):
#   bae-core: no local deps
#   bae-ui: no local deps
#   bae-desktop: depends on bae-core, bae-ui
#   bae-mocks: depends on bae-ui
#   bae-macos: depends on bae-bridge (Swift native app)
#   bae-bridge: depends on bae-core, bae-common

TMPFILE=$(mktemp)

cleanup() {
    rm -f "$TMPFILE"
}
trap cleanup EXIT

# Get changed files (staged for commit)
CHANGED_FILES=$(git --no-pager diff --cached --name-only)

has_changes_in() {
    if echo "$CHANGED_FILES" | grep -q "^$1/"; then
        echo "Changes detected in $1"
        return 0
    fi
    return 1
}

run_check() {
    local name="$1"
    shift
    echo "Running $name..."
    if "$@" > "$TMPFILE" 2>&1; then
        return 0
    else
        echo ""
        echo "❌ $name failed:"
        cat "$TMPFILE"
        return 1
    fi
}

# Auto-format all packages up front, then re-stage changed files
run_check "cargo fmt" cargo fmt --all || {
    echo "cargo fmt failed"
    exit 1
}
for dir in bae-ui bae-desktop bae-mocks; do
    if has_changes_in "$dir"; then
        (cd "$dir" && run_check "dx fmt ($dir)" dx fmt) || {
            echo "dx fmt failed in $dir"
            exit 1
        }
    fi
done
# Re-stage any formatting changes
git --no-pager diff --name-only | while read -r file; do
    if echo "$CHANGED_FILES" | grep -qF "$file"; then
        git add "$file"
    fi
done

# Check for banned patterns in UI components
if ! scripts/check-banned-patterns.sh; then
    echo ""
    echo "❌ Found banned pattern in bae-ui components"
    echo "See error above for details."
    exit 1
fi

# bae-core checks
if has_changes_in "bae-core"; then
    cd bae-core

    run_check "clippy lib (bae-core)" cargo clippy --lib -- -D warnings -A unexpected_cfgs -A deprecated || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    run_check "clippy tests (bae-core)" cargo clippy --tests --features test-utils -- -D warnings -A unexpected_cfgs -A deprecated || {
        exit 1
    }

    for test in tests/*.rs; do
        testname=$(basename "$test" .rs)
        run_check "clippy integration test: $testname" cargo clippy --test "$testname" --features test-utils -- -D warnings -A unexpected_cfgs -A deprecated || {
            exit 1
        }
    done

    run_check "tests (bae-core)" cargo test --features test-utils || {
        echo "Fix the failing tests and try again"
        exit 1
    }

    cd ..
fi

# bae-ui checks
if has_changes_in "bae-ui"; then
    cd bae-ui

    run_check "clippy (bae-ui)" cargo clippy -- -D warnings || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    run_check "clippy wasm32 (bae-ui)" cargo clippy --target wasm32-unknown-unknown -- -D warnings || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    cd ..
fi

# bae-desktop checks (depends on bae-core, bae-ui)
if has_changes_in "bae-desktop" || has_changes_in "bae-core" || has_changes_in "bae-ui"; then
    cd bae-desktop

    run_check "clippy (bae-desktop)" env BINDGEN_EXTRA_CLANG_ARGS="-I/opt/homebrew/include" cargo clippy -- -D warnings -A unexpected_cfgs -A deprecated || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    cd ..
fi

# bae-mocks checks (depends on bae-ui)
if has_changes_in "bae-mocks" || has_changes_in "bae-ui"; then
    cd bae-mocks

    run_check "clippy (bae-mocks)" cargo clippy -- -D warnings || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    run_check "clippy wasm32 (bae-mocks)" cargo clippy --target wasm32-unknown-unknown -- -D warnings || {
        echo "Fix the warnings above and try again"
        exit 1
    }

    cd ..
fi

# bae-macos checks (depends on bae-bridge)
if has_changes_in "bae-macos" || has_changes_in "bae-bridge"; then
    run_check "build bridge (bae-macos)" ./bae-bridge/build-macos.sh || {
        echo "Bridge build failed"
        exit 1
    }

    ln -sf ../bae-bridge/BaeBridgeFFI.xcframework bae-macos/BaeBridgeFFI.xcframework
    cp bae-bridge/swift-bindings/bae_bridge.swift bae-macos/bae/bae/bae_bridge.swift

    if ! command -v xcodegen &> /dev/null; then
        echo "⚠️  xcodegen not installed, skipping macOS build check"
    else
        cd bae-macos/bae
        run_check "xcodegen (bae-macos)" xcodegen || {
            echo "xcodegen failed"
            exit 1
        }
        run_check "xcodebuild (bae-macos)" xcodebuild -project bae.xcodeproj -scheme bae -configuration Debug \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO build || {
            echo "macOS app build failed"
            exit 1
        }
        cd ../..
    fi
fi

echo "✅ All checks passed"
exit 0
