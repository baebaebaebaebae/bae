name: Release

on:
  workflow_dispatch:
    inputs:
      commit:
        description: 'Commit SHA to release (leave blank for HEAD)'
        required: false
        default: ''

concurrency:
  group: release
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  calculate-version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ inputs.commit || github.sha }}
        submodules: true

    - name: Calculate next version from tags and date
      id: calc
      run: |
        YEAR=$(date +%Y)
        MONTH=$(date +%-m)
        
        # Get latest tag for this year.month
        LATEST=$(git tag -l "v${YEAR}.${MONTH}.*" | sort -V | tail -1)
        
        if [[ -z "$LATEST" ]]; then
          # First release this month
          VERSION="${YEAR}.${MONTH}.0"
        else
          # Increment patch from latest tag
          PATCH=$(echo "$LATEST" | sed "s/v${YEAR}\.${MONTH}\.\([0-9]*\)/\1/")
          VERSION="${YEAR}.${MONTH}.$((PATCH + 1))"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "::notice::Next version will be $VERSION"

  ci:
    name: CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ inputs.commit || github.sha }}

  release:
    name: Build and Release
    runs-on: macos-latest
    needs: [calculate-version, ci]
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.commit || github.sha }}
        submodules: true

    - name: Setup macOS environment
      uses: ./.github/actions/setup-macos

    - name: Setup Rust environment
      uses: ./.github/actions/setup-rust
      with:
        install-dioxus: 'true'

    - name: Setup Node.js environment
      uses: ./.github/actions/setup-node
      with:
        include-website: 'true'

    - name: Set release version
      run: |
        VERSION="${{ needs.calculate-version.outputs.version }}"
        echo "BAE_VERSION=$VERSION" >> $GITHUB_ENV
        # Patch Cargo.toml for bundle metadata (not committed)
        sed -i '' "s/^version = .*/version = \"$VERSION\"/" bae-desktop/Cargo.toml
        echo "Building version $VERSION"

    - name: Build app bundle
      working-directory: ./bae-desktop
      run: |
        export PATH="$HOME/.cargo/bin:$PATH"
        # Only build .app bundle, skip DMG (we create our own signed DMG later)
        dx bundle --release --package-types macos

    - name: Archive dSYM bundle
      run: |
        DSYM_PATH=$(find target/release -name "*.dSYM" -type d | head -1)
        if [[ -n "$DSYM_PATH" ]]; then
          zip -r target/bae.dSYM.zip "$DSYM_PATH"
          echo "DSYM_ARCHIVE=target/bae.dSYM.zip" >> $GITHUB_ENV
          echo "Found dSYM at $DSYM_PATH"
        else
          echo "::warning::No dSYM bundle found"
        fi

    - name: Rename app bundle to lowercase
      run: mv target/dx/bae/bundle/macos/bundle/macos/Bae.app target/dx/bae/bundle/macos/bundle/macos/bae.app

    - name: Bundle dylibs into app
      working-directory: ./bae-desktop
      run: ./scripts/bundle_dylibs.sh ../target/dx/bae/bundle/macos/bundle/macos/bae.app

    - name: Import Apple certificate
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      run: |
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
        security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"

    - name: Sign app bundle
      env:
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        APP_PATH="target/dx/bae/bundle/macos/bundle/macos/bae.app"
        IDENTITY=$(security find-identity -v -p codesigning | grep "$APPLE_TEAM_ID" | head -1 | sed 's/.*"\(.*\)".*/\1/')
        echo "Using signing identity: $IDENTITY"
        
        # --- Sparkle.framework signing ---
        # Requires explicit signing of all nested components because codesign --deep
        # doesn't reliably re-sign nested bundles like XPC services.
        SPARKLE_PATH="$APP_PATH/Contents/Frameworks/Sparkle.framework"
        for xpc in "$SPARKLE_PATH/Versions/B/XPCServices"/*.xpc; do
          if [[ -d "$xpc" ]]; then
            echo "Signing $xpc"
            codesign --force --sign "$IDENTITY" --options runtime "$xpc"
          fi
        done
        codesign --force --sign "$IDENTITY" --options runtime "$SPARKLE_PATH/Versions/B/Autoupdate"
        codesign --force --sign "$IDENTITY" --options runtime "$SPARKLE_PATH/Versions/B/Updater.app"
        codesign --force --sign "$IDENTITY" --options runtime "$SPARKLE_PATH"
        # --- End Sparkle.framework signing ---
        
        # Sign all dylibs
        find "$APP_PATH/Contents/Frameworks" -name "*.dylib" -exec \
          codesign --force --sign "$IDENTITY" --options runtime {} \;
        
        # Finally sign the main app
        codesign --force --sign "$IDENTITY" --options runtime "$APP_PATH"
        
        codesign --verify --verbose "$APP_PATH"

    - name: Create signed DMG
      env:
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        APP_PATH="target/dx/bae/bundle/macos/bundle/macos/bae.app"
        DMG_PATH="target/bae.dmg"
        IDENTITY=$(security find-identity -v -p codesigning | grep "$APPLE_TEAM_ID" | head -1 | sed 's/.*"\(.*\)".*/\1/')
        
        # Create temporary directory for DMG contents
        DMG_TEMP=$(mktemp -d)
        trap "rm -rf $DMG_TEMP" EXIT
        
        # Copy app bundle to temp directory, ensuring lowercase name
        cp -R "$APP_PATH" "$DMG_TEMP/bae.app"
        
        # Create Applications folder symlink
        ln -s /Applications "$DMG_TEMP/Applications"
        
        # Create DMG from temp directory
        hdiutil create -volname "bae" -srcfolder "$DMG_TEMP" -ov -format UDZO "$DMG_PATH"
        codesign --force --sign "$IDENTITY" "$DMG_PATH"

    - name: Notarize DMG
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        DMG_PATH="target/bae.dmg"
        
        xcrun notarytool submit "$DMG_PATH" \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_APP_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --wait
        
        xcrun stapler staple "$DMG_PATH"

    - name: Download Sparkle for signing
      run: |
        SPARKLE_VERSION="2.8.1"
        curl -L -o /tmp/sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz"
        mkdir -p /tmp/sparkle
        tar -xf /tmp/sparkle.tar.xz -C /tmp/sparkle

    - name: Sign DMG with Sparkle EdDSA key
      env:
        SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
      run: |
        DMG_PATH="target/bae.dmg"
        
        # Sign the DMG and capture only the signature (-p flag), not the full attribute string
        SIGNATURE=$(echo "$SPARKLE_PRIVATE_KEY" | /tmp/sparkle/bin/sign_update "$DMG_PATH" -f - -p)
        echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
        
        # Get file size for appcast
        DMG_SIZE=$(stat -f%z "$DMG_PATH")
        echo "DMG_SIZE=$DMG_SIZE" >> $GITHUB_ENV

    - name: Generate appcast.xml
      run: |
        VERSION="${{ needs.calculate-version.outputs.version }}"
        DMG_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/bae.dmg"
        
        cat > target/appcast.xml << EOF
        <?xml version="1.0" encoding="utf-8"?>
        <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
          <channel>
            <title>bae Updates</title>
            <link>https://github.com/${{ github.repository }}/releases</link>
            <description>Most recent updates to bae</description>
            <language>en</language>
            <item>
              <title>Version ${VERSION}</title>
              <pubDate>$(date -R)</pubDate>
              <sparkle:version>${VERSION}</sparkle:version>
              <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
              <sparkle:minimumSystemVersion>12.0</sparkle:minimumSystemVersion>
              <enclosure
                url="${DMG_URL}"
                length="${DMG_SIZE}"
                type="application/octet-stream"
                sparkle:edSignature="${SPARKLE_SIGNATURE}"
              />
            </item>
          </channel>
        </rss>
        EOF

    - name: Create git tag
      run: |
        VERSION="${{ needs.calculate-version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag "v$VERSION"
        git push origin "v$VERSION"

    - name: Upload signed DMG
      uses: actions/upload-artifact@v4
      with:
        name: bae-macOS-signed
        path: target/bae.dmg
        retention-days: 30

    - name: Upload dSYM
      if: env.DSYM_ARCHIVE != ''
      uses: actions/upload-artifact@v4
      with:
        name: bae-dSYM
        path: ${{ env.DSYM_ARCHIVE }}
        retention-days: 90

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.calculate-version.outputs.version }}
        files: |
          target/bae.dmg
          target/appcast.xml
          target/bae.dSYM.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-website:
    name: Deploy Website
    needs: [release]
    uses: ./.github/workflows/deploy-website.yml
    with:
      screenshots_artifact: ''
    secrets: inherit
