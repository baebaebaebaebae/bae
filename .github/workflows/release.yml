name: Release

on:
  workflow_dispatch:
    inputs:
      commit:
        description: 'Commit SHA to release (leave blank for HEAD)'
        required: false
        default: ''

concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  calculate-version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ inputs.commit || github.sha }}

    - name: Calculate next version from tags and date
      id: calc
      run: |
        YEAR=$(date +%Y)
        MONTH=$(date +%-m)
        
        # Get latest tag for this year.month
        LATEST=$(git tag -l "v${YEAR}.${MONTH}.*" | sort -V | tail -1)
        
        if [[ -z "$LATEST" ]]; then
          # First release this month
          VERSION="${YEAR}.${MONTH}.0"
        else
          # Increment patch from latest tag
          PATCH=$(echo "$LATEST" | sed "s/v${YEAR}\.${MONTH}\.\([0-9]*\)/\1/")
          VERSION="${YEAR}.${MONTH}.$((PATCH + 1))"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "::notice::Next version will be $VERSION"

  ci:
    name: CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ inputs.commit || github.sha }}

  release:
    name: Build and Release
    runs-on: macos-latest
    needs: [calculate-version, ci]
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.commit || github.sha }}

    - name: Install macOS dependencies
      run: |
        brew install libdiscid libcdio libsodium pkg-config libtorrent-rasterbar boost ffmpeg

    - name: Install Rust (uses rust-toolchain.toml)
      run: rustup show

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        shared-key: rust-cache
        cache-directories: ~/.cargo/bin

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          bae-desktop/package-lock.json
          bae-demo/package-lock.json
          website/package-lock.json

    - name: Install Node dependencies
      run: |
        (cd bae-desktop && npm ci)
        (cd bae-demo && npm ci)
        (cd website && npm ci)

    - name: Install cargo-binstall
      run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

    - name: Install Dioxus CLI
      run: cargo binstall dioxus-cli@0.7.2 --no-confirm

    - name: Set macOS environment
      run: |
        if [[ -d "/opt/homebrew" ]]; then
          echo "PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=/opt/homebrew/lib" >> $GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I/opt/homebrew/include" >> $GITHUB_ENV
        else
          echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=/usr/local/lib" >> $GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I/usr/local/include" >> $GITHUB_ENV
        fi

    - name: Set release version
      run: |
        VERSION="${{ needs.calculate-version.outputs.version }}"
        echo "BAE_VERSION=$VERSION" >> $GITHUB_ENV
        # Patch Cargo.toml for bundle metadata (not committed)
        sed -i '' "s/^version = .*/version = \"$VERSION\"/" bae-desktop/Cargo.toml
        echo "Building version $VERSION"

    - name: Build app bundle
      working-directory: ./bae-desktop
      run: dx bundle --release

    - name: Bundle dylibs into app
      working-directory: ./bae-desktop
      run: ./scripts/bundle_dylibs.sh target/dx/bae/bundle/macos/bundle/macos/bae.app

    - name: Import Apple certificate
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      run: |
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
        security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"

    - name: Sign app bundle
      env:
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        APP_PATH="bae-desktop/target/dx/bae/bundle/macos/bundle/macos/bae.app"
        IDENTITY=$(security find-identity -v -p codesigning | grep "$APPLE_TEAM_ID" | head -1 | sed 's/.*"\(.*\)".*/\1/')
        echo "Using signing identity: $IDENTITY"
        
        codesign --deep --force --verify --verbose \
          --sign "$IDENTITY" \
          --options runtime \
          "$APP_PATH"
        
        codesign --verify --verbose "$APP_PATH"

    - name: Create signed DMG
      env:
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        APP_PATH="bae-desktop/target/dx/bae/bundle/macos/bundle/macos/bae.app"
        DMG_PATH="bae-desktop/target/bae.dmg"
        IDENTITY=$(security find-identity -v -p codesigning | grep "$APPLE_TEAM_ID" | head -1 | sed 's/.*"\(.*\)".*/\1/')
        
        # Create temporary directory for DMG contents
        DMG_TEMP=$(mktemp -d)
        trap "rm -rf $DMG_TEMP" EXIT
        
        # Copy app bundle to temp directory, ensuring lowercase name
        cp -R "$APP_PATH" "$DMG_TEMP/bae.app"
        
        # Create Applications folder symlink
        ln -s /Applications "$DMG_TEMP/Applications"
        
        # Create DMG from temp directory
        hdiutil create -volname "bae" -srcfolder "$DMG_TEMP" -ov -format UDZO "$DMG_PATH"
        codesign --force --sign "$IDENTITY" "$DMG_PATH"

    - name: Notarize DMG
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        DMG_PATH="bae-desktop/target/bae.dmg"
        
        xcrun notarytool submit "$DMG_PATH" \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_APP_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --wait
        
        xcrun stapler staple "$DMG_PATH"

    - name: Download Sparkle for signing
      run: |
        SPARKLE_VERSION="2.8.1"
        curl -L -o /tmp/sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz"
        mkdir -p /tmp/sparkle
        tar -xf /tmp/sparkle.tar.xz -C /tmp/sparkle

    - name: Sign DMG with Sparkle EdDSA key
      env:
        SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
      run: |
        DMG_PATH="bae-desktop/target/bae.dmg"
        
        # Sign the DMG and capture the signature
        SIGNATURE=$(echo "$SPARKLE_PRIVATE_KEY" | /tmp/sparkle/bin/sign_update "$DMG_PATH" -f -)
        echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
        
        # Get file size for appcast
        DMG_SIZE=$(stat -f%z "$DMG_PATH")
        echo "DMG_SIZE=$DMG_SIZE" >> $GITHUB_ENV

    - name: Generate appcast.xml
      run: |
        VERSION="${{ needs.calculate-version.outputs.version }}"
        DMG_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/bae.dmg"
        
        cat > bae-desktop/target/appcast.xml << EOF
        <?xml version="1.0" encoding="utf-8"?>
        <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
          <channel>
            <title>bae Updates</title>
            <link>https://github.com/${{ github.repository }}/releases</link>
            <description>Most recent updates to bae</description>
            <language>en</language>
            <item>
              <title>Version ${VERSION}</title>
              <pubDate>$(date -R)</pubDate>
              <sparkle:version>${VERSION}</sparkle:version>
              <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
              <sparkle:minimumSystemVersion>12.0</sparkle:minimumSystemVersion>
              <enclosure
                url="${DMG_URL}"
                length="${DMG_SIZE}"
                type="application/octet-stream"
                sparkle:edSignature="${SPARKLE_SIGNATURE}"
              />
            </item>
          </channel>
        </rss>
        EOF

    - name: Verify app bundle is properly bundled
      working-directory: ./bae-desktop
      run: |
        set -euo pipefail
        APP_PATH="target/dx/bae/bundle/macos/bundle/macos/bae.app"
        if [[ ! -d "$APP_PATH" ]]; then
          echo "Error: App bundle not found at $APP_PATH"
          exit 1
        fi
        # Check that required libraries are bundled
        if [[ ! -f "$APP_PATH/Contents/Frameworks/libsharpyuv.0.dylib" ]]; then
          echo "Error: libsharpyuv.0.dylib not found in bundle"
          exit 1
        fi
        if [[ ! -f "$APP_PATH/Contents/Frameworks/libjxl_cms.0.11.dylib" ]]; then
          echo "Error: libjxl_cms.0.11.dylib not found in bundle"
          exit 1
        fi
        echo "âœ“ App bundle verification passed"

    - name: Build demo web app
      working-directory: ./bae-demo
      run: dx build --release --platform web

    - name: Install Playwright dependencies
      working-directory: ./bae-demo/e2e
      run: |
        npm ci
        npx playwright install chromium

    - name: Generate screenshots
      working-directory: ./bae-demo/e2e
      run: npx playwright test

    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      with:
        name: website-screenshots
        path: website/public/screenshots/
        retention-days: 1

    - name: Create git tag
      run: |
        VERSION="${{ needs.calculate-version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag "v$VERSION"
        git push origin "v$VERSION"

    - name: Upload signed DMG
      uses: actions/upload-artifact@v4
      with:
        name: bae-macOS-signed
        path: bae-desktop/target/bae.dmg
        retention-days: 30

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.calculate-version.outputs.version }}
        files: |
          bae-desktop/target/bae.dmg
          bae-desktop/target/appcast.xml
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-website:
    name: Deploy Website
    needs: [release]
    uses: ./.github/workflows/deploy-website.yml
    with:
      screenshots_artifact: website-screenshots
    secrets: inherit
