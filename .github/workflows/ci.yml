name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        required: false
        type: string
        default: ''

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]  # Windows disabled until CD libs available

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.sha }}
        submodules: true

    - name: Setup Linux environment
      if: runner.os == 'Linux'
      uses: ./.github/actions/setup-linux

    - name: Setup macOS environment
      if: runner.os == 'macOS'
      uses: ./.github/actions/setup-macos

    # Windows uses MSYS2/MinGW for CD libraries (libcdio, libdiscid) since they're not in vcpkg
    - name: Setup MSYS2 (Windows)
      if: runner.os == 'Windows'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-libcdio
          mingw-w64-x86_64-libdiscid
          mingw-w64-x86_64-libsodium
          mingw-w64-x86_64-libtorrent-rasterbar
          mingw-w64-x86_64-boost
          mingw-w64-x86_64-pkg-config

    - name: Download bae-ffmpeg (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ffmpegDir = "C:\bae-ffmpeg"
        New-Item -ItemType Directory -Force -Path $ffmpegDir | Out-Null
        Invoke-WebRequest -Uri "https://github.com/bae-fm/bae-ffmpeg/releases/download/v8.0.1-bae6/ffmpeg-windows-x86_64.zip" -OutFile "$env:TEMP\ffmpeg.zip"
        Expand-Archive -Path "$env:TEMP\ffmpeg.zip" -DestinationPath $ffmpegDir -Force
        echo "FFMPEG_DIR=$ffmpegDir" >> $env:GITHUB_ENV

    - name: Install MinGW Rust target (Windows)
      if: runner.os == 'Windows'
      run: rustup target add x86_64-pc-windows-gnu

    - name: Set Windows environment
      if: runner.os == 'Windows'
      run: |
        echo "C:\msys64\mingw64\bin" >> $env:GITHUB_PATH
        echo "C:\bae-ffmpeg\bin" >> $env:GITHUB_PATH
        echo "PKG_CONFIG_PATH=C:\msys64\mingw64\lib\pkgconfig;C:\bae-ffmpeg\lib\pkgconfig" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Setup Rust environment
      uses: ./.github/actions/setup-rust
      with:
        install-dioxus: 'true'

    - name: Setup Node.js environment
      uses: ./.github/actions/setup-node

    - name: Check Rust formatting
      run: cargo fmt --all -- --check

    - name: Check RSX formatting
      run: |
        export PATH="$HOME/.cargo/bin:$PATH"
        (cd bae-desktop && dx fmt --check)
        (cd bae-mocks && dx fmt --check)

    - name: Run Clippy (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        cargo clippy --workspace -- -D warnings
        # Check wasm32 targets for UI packages
        cargo clippy -p bae-ui --target wasm32-unknown-unknown -- -D warnings
        cargo clippy -p bae-mocks --target wasm32-unknown-unknown -- -D warnings
        # Check integration tests with test-utils feature
        for test_file in bae-core/tests/*.rs; do
          if [ -f "$test_file" ]; then
            test_name=$(basename "$test_file" .rs)
            echo "Checking integration test: $test_name"
            cargo clippy -p bae-core --test "$test_name" --features bae-core/test-utils -- -D warnings
          fi
        done

    - name: Run Clippy (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        cargo clippy --workspace --target x86_64-pc-windows-gnu -- -D warnings
        for %%f in (bae-core\tests\*.rs) do (
          for %%n in ("%%~nf") do (
            echo Checking integration test: %%~n
            cargo clippy -p bae-core --target x86_64-pc-windows-gnu --test "%%~n" --features bae-core/test-utils -- -D warnings
          )
        )

    - name: Check for WASM-only APIs in desktop code
      if: runner.os != 'Windows'
      run: |
        # These crates compile on native but panic at runtime.
        # cfg-gated usage (target_arch = "wasm32") is fine.
        WASM_ONLY="gloo_timers|gloo_events|gloo_utils"
        if grep -rE "$WASM_ONLY" --include='*.rs' bae-desktop/; then
          echo "::error::Found WASM-only API usage in desktop code."
          exit 1
        fi

    - name: Check for overflow-hidden in UI components
      if: runner.os != 'Windows'
      run: scripts/check-overflow-hidden.sh

    - name: Run tests (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        # Skip CPU test in debug mode - measurements only meaningful in release
        cargo test -p bae-core --features bae-core/test-utils --verbose -- --skip test_playback_cpu
        # Run CPU usage test in release mode for accurate measurements
        cargo test -p bae-core --release --features bae-core/test-utils --test test_playback_cpu --verbose

    - name: Run tests (Windows)
      if: runner.os == 'Windows'
      run: |
        # Skip CPU test in debug mode - measurements only meaningful in release
        cargo test -p bae-core --target x86_64-pc-windows-gnu --features bae-core/test-utils --verbose -- --skip test_playback_cpu
        # Run CPU usage test in release mode for accurate measurements
        cargo test -p bae-core --release --target x86_64-pc-windows-gnu --features bae-core/test-utils --test test_playback_cpu --verbose

  e2e:
    name: E2E Tests
    if: false  # Disabled: flaky and slow. Re-enable when stabilized.
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.sha }}
        submodules: true

    - name: Setup Rust environment
      uses: ./.github/actions/setup-rust
      with:
        install-dioxus: 'true'

    - name: Setup Node.js environment
      uses: ./.github/actions/setup-node

    - name: Install Playwright browsers
      run: cd bae-mocks/e2e && npx playwright install --with-deps chromium

    - name: Run e2e tests
      run: cd bae-mocks/e2e && npx playwright test tests/

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.sha }}
        submodules: true

    - name: Setup Rust environment
      uses: ./.github/actions/setup-rust

    - name: Install cargo-audit
      run: cargo binstall cargo-audit --no-confirm --force

    - name: Run security audit
      run: cargo audit --ignore RUSTSEC-2023-0071
